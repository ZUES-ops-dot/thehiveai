name: HiveAI Tracking Cron

# ============================================================================
# This workflow runs the X post tracking job every 15 minutes.
# It calls the /api/tracking/cron endpoint on your deployed app.
#
# WHY GITHUB ACTIONS INSTEAD OF VERCEL CRON?
# - Vercel rate-limits outgoing HTTP requests (especially to Nitter)
# - Vercel has 60s timeout on hobby plans
# - GitHub Actions has no rate limits on outgoing requests
# - Free tier allows 2000 minutes/month (plenty for 15-min intervals)
#
# REQUIRED SECRETS (set in GitHub repo Settings > Secrets > Actions):
# - APP_URL: Your deployed app URL (e.g., https://hiveai-six.vercel.app)
# - CRON_SECRET: Same value as CRON_SECRET in your Vercel env vars
# ============================================================================

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub Actions UI
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

jobs:
  run-tracking:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "::error::APP_URL secret is not set. Please add it in GitHub repo Settings > Secrets > Actions"
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "::warning::CRON_SECRET not set - endpoint may reject requests"
          fi

      - name: Trigger tracking for all campaigns
        id: tracking
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          DEBUG: ${{ inputs.debug || 'false' }}
        run: |
          # Remove trailing slash from APP_URL if present
          APP_URL="${APP_URL%/}"
          ENDPOINT="$APP_URL/api/tracking/cron"
          
          echo "üêù HiveAI Tracking Cron"
          echo "========================"
          echo "Endpoint: $ENDPOINT"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Retry logic: try up to 3 times with exponential backoff
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES..."
            
            response=$(curl -sS -w "\n%{http_code}" \
              --max-time 120 \
              -H "Authorization: Bearer $CRON_SECRET" \
              -H "Content-Type: application/json" \
              -H "User-Agent: HiveAI-GitHub-Actions/1.0" \
              "$ENDPOINT" 2>&1) || response="Connection failed\n000"
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            echo "HTTP Status: $http_code"
            
            if [ "$DEBUG" = "true" ]; then
              echo "Response Body:"
              echo "$body" | head -c 2000
              echo ""
            fi
            
            # Success
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo ""
              echo "‚úÖ Tracking completed successfully!"
              
              # Parse and display summary if JSON
              if echo "$body" | jq -e . >/dev/null 2>&1; then
                campaigns=$(echo "$body" | jq -r '.campaignsProcessed // 0')
                posts=$(echo "$body" | jq -r '.totalPostsRecorded // 0')
                msp=$(echo "$body" | jq -r '.totalMspAwarded // 0')
                duration=$(echo "$body" | jq -r '.duration // 0')
                
                echo ""
                echo "üìä Summary:"
                echo "   Campaigns processed: $campaigns"
                echo "   Posts recorded: $posts"
                echo "   MSP awarded: $msp"
                echo "   Duration: ${duration}ms"
              fi
              
              exit 0
            fi
            
            # Retry on 5xx errors or connection issues
            if [ "$http_code" -ge 500 ] || [ "$http_code" = "000" ]; then
              if [ $attempt -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Server error, retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
                continue
              fi
            fi
            
            # Non-retryable error
            echo ""
            echo "‚ùå Tracking failed with status $http_code"
            echo "Response: $body"
            exit 1
          done
          
          echo "‚ùå All retry attempts failed"
          exit 1

      - name: Report failure
        if: failure()
        run: |
          echo "::error::Tracking cron failed. Check the logs above for details."
          echo "Common issues:"
          echo "  - APP_URL secret not set or incorrect"
          echo "  - CRON_SECRET mismatch between GitHub and Vercel"
          echo "  - Nitter instances all down"
          echo "  - App deployment issue"
